---
title: "Phase 3 - Data analysis"
format: 
  html: default
  pdf: default
---

## Methodology

How do workforce characteristics, including wage levels, employment size, and net employment change, contribute to variations in CO2 emissions in energy-producing industries over time?

In the first part of our analysis, we will focus on establishing a non-causal relationship between CO2 emissions, and industry characteristics (monthly average wage, industry size and net industry size change) using the Logarithmic Mean Divisia Index (LMDI) decomposition method to identify the contribution of different industry characteristics to changes in CO2 emissions. 

The Logarithmic Mean Divisia Index is an analytical method that breaks down aggregate changes in a variable into several effects to identify the main drivers behind the changes in the variable of interest. Using the logarithmic mean, it allows for consistent results in the presence of zero or missing values. 
THe LMDI can be applied in an additive or a multiplicative method : 
The additive method consists in representing the absolute effect of a factor to the changes in the variable of interest. The total change in the variable of interest is expressed as the sum of the contributions of all the factors taken into account. 
The multiplicative method corresponds to computing the relative contribution of each factor to the changes in the variable of interest (expressed in general in percentages). Then, the variable of interest is expressed as a product of the relative contributions of each variable. 

In this case, we chose to use the Additive LMDI method given the nature of the factors. Indeed, industry and workforce characteristics such as wage and employment size vary in general in absolute terms, which makes the interpretation of their effect in the LMDI decomposition easier using the additive approach. Moreover, this approach makes a cross-sector or a temporal analysis more straightforward than the multiplicative one, where we would be comparing relative impacts across groups. ([Ang, 2015]( https://doi.org/10.1016/j.enpol.2015.07.007))

In the second part of our analysis, we will try to identify the effect of the regulatory environment on CO2 emissions across industries. For this study, we plan on conducting a panel analysis to have more information and to study the evolution in behavior of each industry over time. It will allow us to analyse the heterogeneity of responses of these industries (i.e. if some of them are more responsive to tax on their emissions than others).

To compare regulatory environments, we use California as a treatment group. California is a huge polluting state (second most important emitter of C02 in the US)that has been making efforts to transition towards clean energies as it introduced a cap-and-trade program in 2015 to regulate emissions. Our control group will be Texas, the leading energy supplier in the U.S. that still relies in majority on fossil fuels (most important emitter of C02 in the US). Studying these two states together allows for understanding how a change in environmental policy shapes CO2 emissions at a sectoral level. 

```{r}
#| message: false
#| echo: false

# Creating a Directed Acyclic Graph (DAG), displaying the causal relationships between the variables used in our model

## Installing the packages for the DAG
library(dagitty)
library(ggdag)

## Defining the DAG (first, defining the names and positions of the variables ie. "nodes", and then the orientation of the relations between them)
dag <- dagitty("
dag {
  RegulatoryEnvironment [pos = \"0.5,1\"]
  CO2Emissions [pos = \"1,0\"]
  MonthlyAverageWage [pos = \"-0.25,0\"]
  EmploymentSize [pos = \"-0.25,1.5\"]
  NetEmploymentChange [pos = \"-0.25,-1.5\"]
  IndustryType [pos = \"-1,0\"]
  CapAndTradePolicy [pos = \"0.5,2.5\"]
  California [pos = \"0.5,4\"]
  Texas [pos = \"0.5,-2\"]

  RegulatoryEnvironment -> MonthlyAverageWage
  RegulatoryEnvironment -> EmploymentSize
  RegulatoryEnvironment -> NetEmploymentChange
  IndustryType -> MonthlyAverageWage
  IndustryType -> EmploymentSize
  IndustryType -> NetEmploymentChange
  MonthlyAverageWage -> CO2Emissions
  EmploymentSize -> CO2Emissions
  NetEmploymentChange -> CO2Emissions
  CapAndTradePolicy -> RegulatoryEnvironment
  California -> RegulatoryEnvironment
  Texas -> RegulatoryEnvironment
}
")

## Defining a variable (vector-column) which assigns a color code to each "node"
node_colors <- c(
  "CO2Emissions" = "tomato",
  "MonthlyAverageWage" = "skyblue",
  "EmploymentSize" = "skyblue",
  "NetEmploymentChange" = "skyblue",
  "IndustryType" = "yellow",
  "RegulatoryEnvironment" = "orange",
  "CapAndTradePolicy" = "green",
  "California" = "purple",
  "Texas" = "purple"
)

## Plotting the causal diagram
ggdag(dag, text = FALSE) +
  geom_dag_node(aes(fill = name), shape = 21, size = 15, show.legend = FALSE) + ### fill according to node names
  geom_dag_label(nudge_y = -0.3, size = 3) + ### positioning and resizing the label names
  scale_fill_manual(values = node_colors) +  ### applying the custom color mapping to the nodes
  ggtitle("Causal Diagram for CO2 Emissions Analysis") + ### giving a title to the plot
  theme(plot.title = element_text(hjust = 0.25))
```

Variable of interest

Our dependent variable will be `CO2 emissions (non biogenic)`, which corresponds to the unit of metric tons of CO2 (not issued from biomass) annually emitted by energy-producing facilities. 

Energy-producing firms can be divided in three groups :

- Direct emitters, which correspond to facilities that combust fuels or otherwise put greenhouse gases into the atmosphere directly from their facility (ex. power plants).

- Energy suppliers that supply products into the economy which emit greenhouse gases into the atmosphere, when combusted or released (ex. gasoline production).

- CO2 injection facilities, ie. wells that a CO2 stream into the subsurface (ex. oil pumping).

Independent variables

There is literature highlighting the effect of average number of hours worked on carbon emissions with model including the population/industry size as a factor (see for example [Fitzgerald, 2022](https://doi.org/10.1016/j.erss.2021.102385) ). We decided to keep the size aspect with `avg_Emp` (that proxies the size of an industry by counting the number of employees working) but to analyze the effect of the average annual wage on those carbon emissions.

We chose to use `avg_EarnS` as a proxy for workforce skill level and investment in human capital. The idea behind this is that "greener jobs" (so here represented by jobs associated with firms emitting relatively low levels of C02) tends to hire more skilled workers (see [Bowen et al., 2018](https://www.sciencedirect.com/science/article/pii/S0140988318300963), [Elliott and Lindley (2017)](https://www.sciencedirect.com/science/article/abs/pii/S0921800916311442)) with higher wages associated. Therefore, we expect a negative relationship between wage and CO2 emissions. 

Another key variable is Net employment change (`avg_FrmJbC`) which will be used as a proxy for contraction or expansion of firms in an industry. The hypothesis is that industries with quick expansions may emit more due to production scale (and inverse effect for industries shrinking).

Additionnally, we create dummies to separate our analysis in groups :

- `State` is divided in two (California and Texas)

- A policy dummy was added to study the impact of new regulations aimed at reducing emissions. We will study the heterogeneity of response depending on the industry.

## Data Description

The dataset we will be using for our analysis corresponds to a merge of two datasets : one from the US Census Bureau which provides data on Quarterly workforce characteristics of workers in California and Texas, and another from the US Environmental Protection Agency which provides data on energy-producing facilities in the US. 
 
After merging and cleaning, we ended up with a dataset of 18270 observations from the two States of interest, California and Texas, covering yearly the period 2013 to 2023. We chose this time period because our emissions dataset covers years from 2010 to 2023 but the first years had sparse data. Thus we decided to delete those years for clarity's sake, which should not induce any major changes in further analyses.

The following tables provide an overview of the final joined dataset (Table 1) and a analysis sector by sector of extremum levels and contributions (Table 2).


```{r}
#| echo: false
#| message: false

# Summary table for our joined dataset
dataset_summary <- joined_dataset |>
  ungroup() |>
  summarise(
    "Number of rows" = nrow(joined_dataset),
    "Number of columns" = ncol(joined_dataset),
    "Period" = paste(range(year), collapse= " - "),
    "Periodicity" = "Annual",
    "Extremum levels of CO2 emissions " = paste(range(`Total CO2 Emissions (non_biogenic)`), collapse = " - "),
    # separate the rows that have a "," to not double count firms in several subsectors as distinct values
    "Number of industry" = length(unique(industry)),
    "Number of sectors" = length(unique(`NAICS2  (sectors)`)),
    "Total number of missing values across the sheet" = sum(sapply(joined_dataset, function(x) sum(is.na(x)))),
    "Missing values in one our key variables" = sum(
      #summing every missing values of each key variables and then summing them with each others to obtain the          total
      sum(is.na(`Total CO2 Emissions (non_biogenic)`)),
      sum(is.na(avg_Emp)),
      sum(is.na(avg_EarnS)),
      sum(is.na(avg_FrmJbC)))
  )

NAICS2_level_summary <- joined_dataset |>
  group_by(`NAICS2  (sectors)`) |>
  summarise(
    "Number of rows" = n(),
    "Period" = paste(range(year), collapse= " - "),
    "Periodicity" = "Annual",
    "Extremum levels of CO2 emissions " = paste(range(`Total CO2 Emissions (non_biogenic)`), collapse = " - "),
    # separate the rows that have a "," to not double count firms in several subsectors as distinct values
   "Contribution (%) of the sector in the total CO2 emissions" = 
      100 * sum(`Total CO2 Emissions (non_biogenic)`) / sum(joined_dataset$`Total CO2 Emissions (non_biogenic)`),
   #Contribution of one sector in total emissions divided by the emissions of all sectors 
    "Contribution (%) of California to the total CO2 emissions of the sector" = 
      100 * sum(if_else(State == "CA", `Total CO2 Emissions (non_biogenic)`, 0, missing = 0)) / 
      sum(if_else(State %in% c("CA", "TX"), `Total CO2 Emissions (non_biogenic)`, 0, missing = 0)),
   #Contribution of California to total emissions of the sector, Texas' one is thus obtain by  TX = 100 - CA
    "Number of industry" = length(unique(industry)),
    "Missing values in one our key variables" = sum(
      sum(is.na(`Total CO2 Emissions (non_biogenic)`)),
      sum(is.na(avg_Emp)),
      sum(is.na(avg_EarnS)),
      sum(is.na(avg_FrmJbC)))
  )

## Tables for each summary

dataset_summary |>
  kable("html", caption = "Global database information") |>
  kable_styling(full_width = T, bootstrap_options = c("striped", "hover", "condensed"))


NAICS2_level_summary |>
  kable("html", caption = "Per NAICS 2 database information") |>
  kable_styling(full_width = T, bootstrap_options = c("striped", "hover", "condensed"))
```

We notice that there is no industries in Texas that reported carbon emissions in the NAICS 11 sectors, namely Agriculture, Forestry, Fishing and Hunting. On the other hand, there is no Californian firms that have reported carbon emissions in both NAICS 23 and 49 sectors, namely Construction and Transportation/Warehousing. To ameliorate the readability of our following graphical representations and because their contribution to global carbon emissions are infinitesimal (around 0.001% maximum) we will cancel out those industries from our analysis and interpretations. 
The analysis of carbon emissions of those sectors is indeed interesting but less with our energy-producing approach, according to the three types we defined. For example, the construction sector accounted for 36% of total US CO2 emissions in the US in 2018 ([EIA](https://www.iea.org/reports/global-status-report-for-buildings-and-construction-2019))  but we see that the part we are interested in only accounts for 0.00013% of total C02 emissions in Texas and California.


## Part 1 : Non-causal analysis


### Graphical analysis

```{r}
#| echo: false
#| message: false

# Evolution of Average Monthly Wage, Average Employment and Total CO2 Emissions in selected NAICS2 sectors
joined_dataset |>
  filter(`NAICS2  (sectors)` == "21" | `NAICS2  (sectors)` == "22" | `NAICS2  (sectors)` == "32") |>
  group_by(`NAICS2  (sectors)`, year, State) |>
  summarise(avg_wage_sector = mean(avg_EarnS, na.rm = TRUE), avg_emp_sector = mean(avg_Emp, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = year, y = avg_wage_sector, fill = `NAICS2  (sectors)`)) +
  geom_col()
```

```{r}
#| echo: false
#| message: false

# Evolution of Average Annual Employment in NAICS2 sectors
joined_dataset |>
  group_by(`NAICS2  (sectors)`, year, State) |>
  summarise(avg_emp_sector = mean(avg_Emp, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = year, y = avg_emp_sector, color = `NAICS2  (sectors)`)) +
  geom_line() +
  facet_wrap(vars(State))
```

```{r}
# Evolution of Net Employment Change in NAICS2 sectors
joined_dataset |>
  group_by(`NAICS2  (sectors)`, year, State) |>
  summarise(avg_emp_change_sector = mean(avg_FrmJbC, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = year, y = avg_emp_change_sector, color = `NAICS2  (sectors)`)) +
  geom_line() +
  facet_wrap(vars(State))
```


### LMDI decomposition



## Model Fitting



## Testing the model



## Extension of the model



## Conclusion


